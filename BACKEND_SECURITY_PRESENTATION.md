# 오늘의 운세 - 백엔드 및 보안 설명서

발표용 핵심 요약 문서

---

## 1. 프로젝트 개요

AI 기반 한국어 운세 챗봇 서비스
- 생년월일 입력 시 12별자리 기반 맞춤 운세 제공
- 실시간 AI 응답 스트리밍
- 회원가입/로그인, 채팅 기록 저장

---

## 2. 기술 스택

### 프론트엔드
- HTML, CSS, Vanilla JavaScript (프레임워크 없음)

### 백엔드
- TypeScript + Cloudflare Workers (서버리스)
- Llama 3.1 8B AI (운세 생성)
- D1 Database (SQLite 기반)

### 왜 Cloudflare Workers?
```
전통 서버: 서울 서버 → 미국 사용자 느림 (300ms)
Workers: 전 세계 300개 도시 → 가까운 곳에서 응답 (50ms)
```

**장점:** 빠른 속도, 서버 관리 불필요, 저렴한 비용

---

## 3. 핵심 보안 메커니즘

### A. 비밀번호 암호화 (PBKDF2)

```
입력: mypassword123
처리: 소금(랜덤) + 100,000번 반복
저장: $2y$10$a3f9k2j1...해시값...
```

**일반인 설명:**
비밀번호를 고기 분쇄기에 100,000번 갈아서 저장하는 것과 같습니다.
한 번 갈린 고기는 다시 원래 고기로 되돌릴 수 없듯이, 저장된 암호는
원래 비밀번호로 복원이 불가능합니다.

**왜 안전한가?**
```
위험한 방법 (사용 안 함):
비밀번호: password123
저장: password123 (그대로)
→ 해커가 데이터베이스 훔치면 바로 보임

안전한 방법 (우리가 사용):
비밀번호: password123
소금: x8k2Pq9m (사용자마다 다름)
100,000번 암호화
저장: $2y$10$x8k2Pq9m...Nf7j2K8pQ (되돌릴 수 없음)
→ 해커가 데이터베이스 훔쳐도 원본 비밀번호 알 수 없음
→ 같은 비밀번호를 쓰는 사용자들도 다르게 저장됨
```

**실제 보호 효과:**
- 해커가 해독하려면: 슈퍼컴퓨터로 수년 소요
- 같은 비밀번호 "password123"도:
  - 홍길동: $2y$10$abc...xyz
  - 김철수: $2y$10$def...uvw (완전히 다름)
- "소금"(Salt) 덕분에 rainbow table 공격도 무용지물

---

### B. SQL Injection 방어

```typescript
// 위험: 문자열 연결
query = "SELECT * FROM users WHERE username = '" + input + "'";

// 안전: Prepared Statements
env.DB.prepare("SELECT * FROM users WHERE username = ?").bind(input);
```

**일반인 설명:**
은행 창구 직원에게 전달하는 것과 같습니다.

**위험한 방법:**
```
당신: "홍길동의 잔액 알려주세요. 아니면 모든 고객 정보 보여주세요"
직원: "네!" (모든 정보 출력)
→ 명령어를 마음대로 추가 가능
```

**안전한 방법:**
```
당신: 양식에 이름만 적음 "홍길동"
직원: 양식에 적힌 이름만 확인
→ 추가 명령어는 무시됨
```

**실제 공격 예시:**
```
해커 입력: admin' OR '1'='1
위험한 처리:
  SELECT * FROM users WHERE username = 'admin' OR '1'='1'
  → 모든 사용자 정보 노출!

안전한 처리:
  SELECT * FROM users WHERE username = 'admin'' OR ''1''=''1'
  → "admin' OR '1'='1" 이라는 이름의 사용자 검색 (없음)
  → 공격 실패
```

---

### C. XSS 방어

```typescript
// 특수문자 자동 변환
<script>악성코드</script> → &lt;script&gt;악성코드&lt;/script&gt;
```

**일반인 설명:**
게시판에 글을 쓸 때 자동으로 위험한 내용을 무해하게 바꾸는 것입니다.

**공격 시나리오 (방어 안 하면):**
```
1. 해커가 댓글 작성: <script>모든 사람의 비밀번호 전송()</script>
2. 다른 사용자가 댓글 봄
3. 브라우저가 스크립트 실행
4. 그 사용자의 정보가 해커에게 전송됨
```

**우리의 방어:**
```
해커 입력: <script>alert('해킹')</script>
변환 후 저장: &lt;script&gt;alert('해킹')&lt;/script&gt;
화면 표시: <script>alert('해킹')</script> (그냥 텍스트)
→ 코드가 실행되지 않고 글자로만 보임
```

**비유:**
```
방어 전: 칼을 그대로 전달
방어 후: 칼을 장난감 칼로 바꿔서 전달
→ 위험 없음
```

**변환 목록:**
```
< → &lt;
> → &gt;
& → &amp;
" → &quot;
' → &#39;
```

---

## 4. 현재 보안 취약점 (Top 3)

### 심각도: 높음

**1. JWT 비밀키 하드코딩**
```typescript
const JWT_SECRET = "secret-key-change-this-in-production";
```

**일반인 설명:**
은행 금고의 비밀번호를 현관문에 포스트잇으로 붙여놓은 것과 같습니다.
누구나 GitHub에서 코드를 보면 비밀키를 알 수 있어, 가짜 로그인 증명서를 만들어
아무 계정이든 마음대로 접속할 수 있습니다.

**문제점:**
- 소스코드 GitHub 공개 → 누구나 열람 가능
- 가짜 토큰 제작 가능
- 해결: 환경 변수 사용

---

**2. 토큰 만료 시간 없음**
- 토큰이 영구 유효
- 도난 시 계속 악용 가능
- 해결: 24시간 만료 설정

**일반인 설명:**
영화관 티켓이 한 번 받으면 평생 쓸 수 있는 것과 같습니다.
누군가 당신의 티켓을 훔쳐가면, 그 사람이 평생 동안 당신 계정으로 
로그인할 수 있습니다. 로그아웃을 해도 훔쳐간 티켓은 계속 유효합니다.

**예시 상황:**
```
카페에서 로그인 → 티켓 발급
누군가 내 티켓 훔침
1년 후에도 그 티켓으로 내 계정 접속 가능
비밀번호 바꿔도 소용없음 (티켓은 그대로)
```

---

**3. LocalStorage 토큰 저장**
- JavaScript로 접근 가능
- XSS 공격 시 탈취 위험
- 해결: HttpOnly Cookie 사용

**일반인 설명:**
비밀번호를 책상 위에 메모지로 올려놓은 것과 같습니다.
악성 웹사이트나 해킹된 광고가 실행되면, 브라우저에 저장된 당신의
로그인 티켓을 몰래 가져갈 수 있습니다.

**공격 시나리오:**
```
1. 사용자가 우리 사이트에 로그인 (티켓이 LocalStorage에 저장됨)
2. 다른 탭에서 해킹된 사이트 방문
3. 악성 코드가 우리 사이트의 LocalStorage 읽기
4. 티켓 탈취 완료 → 해커가 사용자 계정 접속
```

**HttpOnly Cookie란?**
금고에 넣어 자물쇠를 채운 것처럼, JavaScript가 절대 접근할 수 없게 
브라우저가 자동으로 보호해주는 저장 방식입니다.

---

### 심각도: 중간

**4. Rate Limiting 없음**
- 무제한 로그인 시도 (비밀번호 무작위 대입)
- 무제한 회원가입 (스팸 계정)
- 무제한 AI 요청 (비용 폭탄)

**일반인 설명:**
은행 ATM에 비밀번호 시도 제한이 없는 것과 같습니다.
해커가 하루 종일 비밀번호를 1번부터 9999번까지 계속 시도해도
막을 방법이 없습니다. 또한 AI 운세를 무한정 요청하면 우리가 
AI 사용료를 무제한으로 내야 해서 파산할 수 있습니다.

**실제 위험:**
```
비밀번호 무작위 대입:
- 자동 프로그램으로 1초에 100번 시도
- 8자리 숫자 비밀번호: 약 2시간이면 뚫림
- 현재는 막을 방법 없음

AI 비용 폭탄:
- 악의적 사용자가 자동화 스크립트로 AI 요청 1만번/시간
- AI 사용료: 요청당 $0.01
- 하루 비용: $2,400 (약 300만원)
```

**해결 방법:**
```
로그인 시도: 5회 실패 → 15분 대기
회원가입: IP당 하루 3개만
AI 요청: 사용자당 시간당 30회
```

---

## 5. 보안 개선 로드맵

### 즉시 조치 (Priority 1)
1. JWT_SECRET 환경 변수화 (10분, 무료)
2. JWT 만료 시간 추가 (30분, 무료)
3. HttpOnly Cookie 적용 (2시간, 무료)

### 1주일 내 (Priority 2)
4. Rate Limiting 구현 (4시간, 월 $5)
5. CORS 정책 설정 (1시간, 무료)

### 1개월 내 (Priority 3)
6. 비밀번호 강도 검증 강화 (2시간, 무료)

---

## 6. 성능 및 비용

### 현재 성능
- 로그인: 150ms
- AI 운세: 2-3초 (스트리밍)
- 글로벌 응답 속도: 50ms

### 운영 비용 (1,000명 기준)
```
현재 (무료 티어): $0/월
확장 시 (10,000명): $25/월
전통 서버 (AWS): $100/월
```

**비용 절감: 75%**

---

## 7. 결론

### 강점
- 빠른 글로벌 응답 속도
- 확장 가능한 서버리스 구조
- 저렴한 운영 비용

### 개선 필요
- 3가지 주요 보안 취약점 즉시 해결 필수
- Rate Limiting 추가로 비용 폭탄 방지

### 최종 평가
현대적이고 효율적인 기술 스택이지만,
보안 측면에서 우선순위 높은 조치가 필요합니다.

---

## 부록: 필수 용어

- **JWT**: 로그인 증명서 (영화표와 같은 개념)
- **API**: 프로그램 간 통신 방법
- **XSS**: 악성 스크립트 주입 공격
- **SQL Injection**: 데이터베이스 명령 조작 공격
- **CDN**: 전 세계 데이터센터 네트워크

---

작성일: 2026년 1월 5일
문서 버전: 2.0 (핵심 요약)
